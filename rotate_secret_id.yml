---
- name: Rotate secret_id
  hosts: localhost
  become: true
  tasks:
  - name: Generate a secret-id for the given approle
    community.hashi_vault.vault_write:
      url: "{{ vault_addr }}"
      path: auth/approle/role/aap2_controller/secret-id
      auth_method: approle
      role_id: "{{ role_id }}"
      secret_id: "{{ secret_id }}"
    register: new_secret_id
  
  - name: Display the role ID and secret ID
    ansible.builtin.debug:
      msg:
        - "secret-id: {{ new_secret_id.data.data.secret_id }}"
      
  - name: Update custom cred and built-in cred with new secret id
    ansible.builtin.uri:
      url: https://10.0.1.4/api/v2/credentials/vault_trust_approle++HashiCorp%20Vault%20Secret%20Lookup+external++Default/
      method: PATCH
      body_format: json
    body:
        "inputs": {
        "role_id": "$encrypted$",
        "secret_id": "new-unlock",
        }
      name: your_username
      password: your_password
      enter: Sign in
    status_code: 302
  register: login
  
  name: Create a Vault credential (example for notes)
  credential:
    controller_password: password
    controller_username: admin
    name: vault_trust_approle
    credential_type: HashiCorp Vault Secret Lookup
    organization: Default
    inputs:
      secret_id: "{{ new_secret_id.data.data.secret_id }}"
  
 # rIwa9qRRJ6cNS59td0LsWjQc5IoeCypuHtoJAZBj
 # BzImEwwTZlByrY73341WehgxHXijKJCUByet8cwjXMWX8ooGiMmHVU0VuIO8Htu9lYKhLmb1iPPNfzHAqk0Yxojv8nCIWUhYHc981mDPtS3doeR55WRJocw5d8eC60To
      
